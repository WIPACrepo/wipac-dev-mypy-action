name: 'WIPAC Dev Mypy'
description: 'GitHub Action Package for Running Mypy'

# inputs:
#   who-to-greet:  # id of input
#     description: 'Who to greet'
#     required: true
#     default: 'World'

# outputs:
#   random-number:
#     description: "Random number"
#     value: ${{ steps.random-number-generator.outputs.random-id }}

runs:
  using: "composite"
  steps:
    - run: pip install --upgrade pip
      shell: bash
    - run: pip install mypy
      shell: bash
    - name: Pip Install Local Package and All 'requirements*.txt' Files We Find
      run: |
        ([ -e "setup.py" ] && pip install .) || (echo "no setup.py")
        # ex: pip install -r requirements.txt requirements-dev.txt foo/requirements.txt
        (pip install `find . -name 'requirements*.txt' | rev | sed -z 's/\n/ r- /g' | rev`) || (echo "no requirements*.txt files")
      shell: bash
    - name: Run Mypy (and Try to Install Type-Packages)
      run: |
        flags="--namespace-packages --exclude build/"
        it_flags="--install-types --non-interactive"
        # do mypy (may fail the first time if missing 3rd party packages, second time uses mypy cache for 3rd party packages)
        (mypy $it_flags $flags -v . 2> stderr.txt) || (mypy $flags -v . 2> stderr.txt)
        # show which files were looked at (-v must be used to produce file names)
        grep "Found source" stderr.txt | sed "s_.*path='\(.*\)py'.*_\1py_"
      shell: bash
